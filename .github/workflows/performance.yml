name: Performance Testing

on:
  pull_request:
    branches: [main]
    paths:
      - 'packages/aimms-web-frontend/**'
      - '.github/workflows/performance.yml'
  push:
    branches: [main]
    paths:
      - 'packages/aimms-web-frontend/**'

jobs:
  lighthouse:
    name: Lighthouse CI
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: packages/aimms-web-frontend/package-lock.json

      - name: Install dependencies
        working-directory: packages/aimms-web-frontend
        run: npm ci

      - name: Build application
        working-directory: packages/aimms-web-frontend
        run: npm run build

      - name: Run Lighthouse CI
        working-directory: packages/aimms-web-frontend
        run: |
          npm install -g @lhci/cli
          lhci autorun
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Upload Lighthouse results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-results
          path: packages/aimms-web-frontend/.lighthouseci
          retention-days: 30

  bundle-size:
    name: Bundle Size Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: packages/aimms-web-frontend/package-lock.json

      - name: Install dependencies
        working-directory: packages/aimms-web-frontend
        run: npm ci

      - name: Build application
        working-directory: packages/aimms-web-frontend
        run: npm run build

      - name: Analyze bundle size
        working-directory: packages/aimms-web-frontend
        run: |
          echo "## Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Get sizes of main chunks
          if [ -d "dist/assets" ]; then
            echo "### JavaScript Chunks" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            ls -lh dist/assets/*.js | awk '{print $9, $5}' >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            # Calculate total JS size
            total_js=$(find dist/assets -name "*.js" -type f -exec du -ch {} + | grep total | cut -f1)
            echo "**Total JavaScript:** $total_js" >> $GITHUB_STEP_SUMMARY

            # Calculate total compressed size
            if ls dist/assets/*.js.gz 1> /dev/null 2>&1; then
              total_gz=$(find dist/assets -name "*.js.gz" -type f -exec du -ch {} + | grep total | cut -f1)
              echo "**Total Gzipped:** $total_gz" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Check bundle size budget
        working-directory: packages/aimms-web-frontend
        run: |
          # Find the largest JS chunk
          largest=$(find dist/assets -name "*.js" -type f -exec du -b {} + | sort -n | tail -1 | cut -f1)
          max_size=$((500 * 1024))  # 500KB in bytes

          echo "Largest chunk: $largest bytes"
          echo "Maximum allowed: $max_size bytes"

          if [ $largest -gt $max_size ]; then
            echo "âŒ Bundle size exceeds budget! ($largest bytes > $max_size bytes)"
            exit 1
          else
            echo "âœ… Bundle size within budget ($largest bytes <= $max_size bytes)"
          fi

      - name: Upload bundle stats
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-stats
          path: packages/aimms-web-frontend/dist/stats.html
          retention-days: 30

  performance-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [lighthouse, bundle-size]
    if: always()

    steps:
      - name: Create summary
        run: |
          echo "## ðŸš€ Performance Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Performance testing completed for this PR." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š Lighthouse Results" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Bundle Size Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Review the artifacts for detailed performance metrics." >> $GITHUB_STEP_SUMMARY
